var tabList=[];
var titleList=[];
var tabMax=0;
var tabFocus='tab_0';
var tabCurrent=0;

function loadPage(tag, href){
  //$('#uploading').fadeIn();
  $.ajax({
    url     : href,
    dataType: 'html',
    type    : 'GET',
    async   : false,
    data    : {},
    success : function(response, status, jqXHR){
      $('#'+tag).html(response);
    },
    error   : function(jqXHR, status, err){
    },
    complete: function(jqXHR, status){
      //$('#uploading').fadeOut("slow");
    }
  });
}

function addTab(title, href){
  if(tabList.length < 100){
    tabMax++;
    tabCurrent=tabMax;
    tabFocus='tab_'+tabMax;

    var _htmlTitle='<li tab="'+tabFocus+'" class='" onclick="tabChange('+tabMax+');">';
    _htmlTitle+='<a href="#'+tabFocus+'" _href="'+href+'" data-toggle="tab" aria-expanded="false">'+title+'</a>';
    _htmlTitle+='</li>';

    var _htmlContent='<div class='tab-pane" id="'+tabFocus+'"></div>';
    $('#tabTitle').append(_htmlTitle);
    $('#tabContent').append(_htmlContent);
    $('a[href="#'+tabFocus+'"]').tab('show');

    // gan thong tin
    tabList.push(tabFocus);
    titleList.push(title);

    // load html
    loadPage(tabFocus, href);
  }
}

function tabChange(_tabCurrent){
  tabCurrent=_tabCurrent;
  tabFocus='tab_'+tabCurrent;

  //var _href = $('a[href="#'+tabFocus+'"]').attr('_href');
  //loadPage(tabFocus, _href);
}

function closeTab(){
  if(tabCurrent > 0){
    // vi tri tab list
    var tabIndex = tabList.indexOf(tabFocus);
    //console.log(tabIndex);

    // loai bo html
    $('li[tab="'+tabFocus+'"]').remove();
    $('#'+tabFocus).remove();

    // gan lai tab list
    var titleValues=titleList[tabIndex];
    var filtertabList = tabList.filter(tabList => tabList !== 'tab_'+tabCurrent);
    tabList=filtertabList;

    console.log(titleValues);
    var filtertitleList = titleList.filter(titleList => titleList !== titleValues);
    titleList=filtertitleList;
    //console.log(tabList);
    //console.log(titleList);

    //console.log(tabList.length);
    if(tabList.length >= 1){
      if(tabIndex == 0){
        tabFocus = tabList[tabIndex];
      }else{
        tabFocus = tabList[tabIndex-1];
      }

      tabCurrent=tabFocus.replace(/[^0-9]+/g, "");
      $('a[href="#'+tabFocus+'"]').tab('show');
    }
  }else{
    //console.log('Not Active.');
    alert('Bạn chưa chọn tab.');
  }
}

$(document).ready(function () {
  $('html').append('<div id="uploading"><img class='loadCenter" src="./assets/img/loading.gif"></div>');
  var bodyHeight = $("body").height()
  var docHeight = $(document).height();
  if(bodyHeight > docHeight){
    docHeight = bodyHeight;
  }
  var docWidth = $(document).width();
  $('#uploading').css('width', docWidth + 'px');
  $('#uploading').css('height', docHeight + 'px');

  $('a.sysPageLoad').click(function(){
    var _href=$(this).attr('href');
    var _title=$(this).attr('_title');
    var titleIndex = titleList.indexOf(_title);

    if(titleIndex >= 0){
      tabFocus = tabList[titleIndex];
      tabCurrent = tabFocus.replace(/[^0-9]+/g, "");
      $('a[href="#'+tabFocus+'"]').tab('show');

      // load html
      var _href=$('a[href="#'+tabFocus+'"]').attr('_href');
      loadPage(tabFocus, _href);
    }else{
      addTab(_title, _href);
    }
    return false;
  });
});